USE [master]
GO

/****** Object:  StoredProcedure [dbo].[sp_index_rebuild_and_reorganise]    Script Date: 03/18/2014 15:39:25 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_index_rebuild_and_reorganise]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[sp_index_rebuild_and_reorganise]
GO

USE [master]
GO

/****** Object:  StoredProcedure [dbo].[sp_index_rebuild_and_reorganise]    Script Date: 03/18/2014 15:39:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






/**********************************************************************************************
$Author: Azim Lanewala $
$Revision: 1 $
$Workfile: sp_index_rebuild_and_reorganise.sql $
$Date: 27/02/14 13:44 $
Desc: Gives Recommendation according to min and max fragmentation percentage either rebuild or reorganise
**********************************************************************************************/

CREATE PROCEDURE [dbo].[sp_index_rebuild_and_reorganise]

	 @REORG_FRAGMENTATION_PERC		INT = 10
	,@REBUILD_FRAGMENTATION_PERC	INT = 30
	,@FILLFACTOR					INT = 80
	,@DEBUG							BIT = 1

AS

BEGIN

BEGIN TRY

	SET NOCOUNT ON

	DECLARE @INDEXSTATS TABLE
	(
		 TABLENAME		VARCHAR(200)
		,INDEXNAME		VARCHAR(200)
		,INDEXTYPE		VARCHAR(200)
		,AVG_PERCENATGE INT
		,RECOMMENDATION	VARCHAR(50)
		,COMMAND		VARCHAR(MAX)			
	)

	INSERT INTO @INDEXSTATS
	SELECT  OBJECT_NAME(IND.ID)		   AS TABLENAME 
		   ,IND.NAME                   AS INDEXNAME 
		   ,INDEXSTATS.INDEX_TYPE_DESC AS INDEXTYPE 
		   ,INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT 
		   ,NULL
		   ,NULL
	FROM   SYS.DM_DB_INDEX_PHYSICAL_STATS(DB_ID(), NULL, NULL, NULL, NULL) INDEXSTATS 
		   INNER JOIN SYSINDEXES IND ON IND.ID = INDEXSTATS.OBJECT_ID AND IND.INDID = INDEXSTATS.INDEX_ID 
	WHERE  INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT > 5 AND INDEXSTATS.PAGE_COUNT > 1000 AND INDEX_TYPE_DESC <> 'HEAP'
	ORDER  BY INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT DESC

	UPDATE @INDEXSTATS 
	SET RECOMMENDATION = 'REBUILD'
		,COMMAND = 'ALTER INDEX [' + INDEXNAME + '] ON ' + 'DBO.' + TABLENAME + ' REBUILD WITH (FILLFACTOR = ' + CONVERT(VARCHAR,@FILLFACTOR) + ' , SORT_IN_TEMPDB = ON, STATISTICS_NORECOMPUTE = ON);'
	WHERE AVG_PERCENATGE >= @REBUILD_FRAGMENTATION_PERC
	
	UPDATE @INDEXSTATS 
	SET RECOMMENDATION = 'REORGANIZE' 
		,COMMAND = 'ALTER INDEX [' + INDEXNAME + '] ON ' + 'DBO.' + TABLENAME +' REORGANIZE ;'
	WHERE AVG_PERCENATGE >= @REORG_FRAGMENTATION_PERC AND AVG_PERCENATGE < @REBUILD_FRAGMENTATION_PERC
	
	UPDATE @INDEXSTATS SET RECOMMENDATION = 'NO ACTION REQUIRED' 
	WHERE RECOMMENDATION IS NULL


	IF @DEBUG = 0
		BEGIN
			
			DECLARE @RECOMMENDATION VARCHAR(200),@COMMAND VARCHAR(1000)

			DECLARE CUR_AVG_INDEX CURSOR
			FOR SELECT RECOMMENDATION
					  ,COMMAND
				FROM @INDEXSTATS

			OPEN CUR_AVG_INDEX
			FETCH NEXT FROM CUR_AVG_INDEX INTO @RECOMMENDATION ,@COMMAND	

			WHILE (@@FETCH_STATUS = 0)		   		
			BEGIN							   	
		
			  EXEC (@COMMAND)
			
			  FETCH NEXT FROM CUR_AVG_INDEX INTO @RECOMMENDATION ,@COMMAND
			
			END
			
			CLOSE CUR_AVG_INDEX
			DEALLOCATE CUR_AVG_INDEX   	
			
		END
	
	ELSE
		BEGIN				
				SELECT 
					 TABLENAME		
					,INDEXNAME		
					,INDEXTYPE		
					,AVG_PERCENATGE 
					,RECOMMENDATION	
					,COMMAND
				FROM @INDEXSTATS
		END
	
	
END TRY

BEGIN CATCH

	DECLARE @ERRORMESSAGE NVARCHAR(4000), @ERRORPROC NVARCHAR(126), @ERRORLINENO INT;

	-- ERROR HANDLING - GRAB ERROR CODE AND THROW
	SELECT @ERRORLINENO = ERROR_LINE(), @ERRORMESSAGE = ERROR_MESSAGE(), @ERRORPROC = ERROR_PROCEDURE();
	RAISERROR('ERROR %s OCCURRED IN %s. LINE %d', 16, 1, @ERRORMESSAGE, @ERRORPROC, @ERRORLINENO) WITH SETERROR;
		
				
END CATCH


/*
				IF (@AVG_PERCENATGE > @REBUILD_FRAGMENTATION_PERC)
					BEGIN
						IF @DEBUG = 1
							SELECT @TABLENAME , @INDEXNAME , @AVG_PERCENATGE , ''ALTER INDEX REBUILD WITH (ONLINE = ON)*''
						ELSE
							SELECT 'ALTER INDEX ' + @INDEXNAME + ' ON ' + 'DBO.' + @TABLENAME + ' REBUILD WITH (FILLFACTOR = ' + CONVERT(VARCHAR,@FILLFACTOR) + ' , SORT_IN_TEMPDB = ON, STATISTICS_NORECOMPUTE = ON);'
					END 
				ELSE 
					IF (@AVG_PERCENATGE > @REORG_FRAGMENTATION_PERC)
						BEGIN 
							IF @DEBUG = 1
								SELECT @TABLENAME , @INDEXNAME , @AVG_PERCENATGE ,'ALTER INDEX REORGANIZE'
							ELSE
								SELECT 'ALTER INDEX ' + @INDEXNAME + ' ON ' + 'DBO.' + @TABLENAME +' REORGANIZE ;'
						END
					ELSE
						IF @DEBUG = 1
							SELECT @TABLENAME , @INDEXNAME , @AVG_PERCENATGE ,'DO NOTHING'
							
*/


END

GO
