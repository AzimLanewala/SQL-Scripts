USE YOUR_DB_NAME

DECLARE @DBNAME VARCHAR(2000) , @BUILDSTR VARCHAR(2000), @SEARCHSTR VARCHAR(2000), @DB_NAME VARCHAR(2000)

SET @DBNAME = 'YOUR_DB_NAME'

SET @BUILDSTR = 'USE ' + @DBNAME + CHAR(13) +	

'
DECLARE @INDEXSTATS TABLE
(
	 TABLENAME		VARCHAR(200)
	,INDEXNAME		VARCHAR(200)
	,INDEXTYPE		VARCHAR(200)
	,AVG_PERCENATGE INT
)

INSERT INTO @INDEXSTATS
SELECT  OBJECT_NAME(IND.OBJECT_ID) AS TABLENAME 
       ,IND.NAME                   AS INDEXNAME 
       ,INDEXSTATS.INDEX_TYPE_DESC AS INDEXTYPE 
       ,INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT 
FROM   SYS.DM_DB_INDEX_PHYSICAL_STATS(DB_ID(), NULL, NULL, NULL, NULL) INDEXSTATS 
       INNER JOIN SYS.INDEXES IND ON IND.OBJECT_ID = INDEXSTATS.OBJECT_ID AND IND.INDEX_ID = INDEXSTATS.INDEX_ID 
WHERE  INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT > 10 AND INDEXSTATS.PAGE_COUNT > 1000
ORDER  BY INDEXSTATS.AVG_FRAGMENTATION_IN_PERCENT DESC' + CHAR(13)+ 
'
--SELECT * FROM @INDEXSTATS' + CHAR(13)+ 

'
DECLARE @TABLENAME VARCHAR(200),@INDEXNAME	VARCHAR(200),@INDEXTYPE VARCHAR(200),@AVG_PERCENATGE INT

DECLARE CUR_AVG_INDEX CURSOR
FOR
SELECT 
	 TABLENAME		
	,INDEXNAME		
	,INDEXTYPE		
	,AVG_PERCENATGE
FROM @INDEXSTATS

OPEN CUR_AVG_INDEX
FETCH NEXT FROM CUR_AVG_INDEX INTO 	 @TABLENAME	,@INDEXNAME	,@INDEXTYPE	,@AVG_PERCENATGE

WHILE (@@FETCH_STATUS = 0)		   		
BEGIN							   	

	IF (@AVG_PERCENATGE > 30)
	BEGIN
			--SELECT @TABLENAME , @INDEXNAME , @AVG_PERCENATGE , ''ALTER INDEX REBUILD WITH (ONLINE = ON)*''
			SELECT ''ALTER INDEX '' + @INDEXNAME + '' ON '' + ''DBO.'' + @TABLENAME +'' REORGANIZE ;''
	END 
	ELSE IF (@AVG_PERCENATGE > 10 AND @AVG_PERCENATGE < = 30)
	BEGIN 
			--SELECT @TABLENAME , @INDEXNAME , @AVG_PERCENATGE ,''ALTER INDEX REORGANIZE''
			SELECT ''ALTER INDEX '' + @INDEXNAME + '' ON '' + ''DBO.'' + @TABLENAME + '' REBUILD WITH (FILLFACTOR = 80, SORT_IN_TEMPDB = ON,STATISTICS_NORECOMPUTE = ON);''
	END

  FETCH NEXT FROM CUR_AVG_INDEX INTO @TABLENAME	,@INDEXNAME	,@INDEXTYPE	,@AVG_PERCENATGE
END
CLOSE CUR_AVG_INDEX
DEALLOCATE CUR_AVG_INDEX   

'

PRINT (@BUILDSTR)	
EXEC (@BUILDSTR)
